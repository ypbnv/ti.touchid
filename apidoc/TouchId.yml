name: Modules.TouchId
summary: Allows a Titanium application to use the iOS Touch ID authentication mechanism.
platforms: [iphone, ipad, android]
since: {iphone: "3.4.0", ipad: "3.4.0", android: "5.4.0"}
extends: Titanium.Module
deprecated:
    since: "6.3.0"
description: |

    ### WARNING
    This module has been deprecated in Titanium SDK 6.3.0+ in favor of the [Ti.Identity](https://github.com/appcelerator-modules/titanium-identity) module
    that includes the 1:1 same API's as this one but also more current API's like FaceID-related constants
    and a unified naming-scheme to avoid confusions regarding the name "TouchID".

    Touch ID is a security mechanism that uses a fingerprint to authenticate the user. The
    fingerprint sensor is located in the Home button of the device. Users can use their fingerprint
    instead of entering their passcode for authentication.

    ### Requirements

    The Touch ID module is available with the Titanium SDK starting with Release 3.4.0.
    This module only works with devices running iOS 8. You can only test the Touch ID module on a device.

    The device must have a Touch ID sensor in the Home button and Touch ID must be setup in order to use
    the Touch ID authentication mechanism. You can set up Touch ID in iOS Setup Assistant or by
    tapping **Touch ID & Passcode** from Settings.

    For information on setting up Touch ID, see
    [iPhone 5s: Using Touch ID](http://support.apple.com/kb/HT5883).

    ### Getting Started

    Add the module as a dependency to your application by adding a **`<module>`** item to the
    **`<modules>`** element of your `tiapp.xml` file:

        <ti:app>
          ...
          <modules>
            <module platform="iphone">ti.touchid</module>
          </modules>
          ...
        </ti:app>

    Use `require()` to access the module from JavaScript:

        var TouchID = require('ti.touchid');

    The `TouchId` variable is a reference to the module. Make API calls using this reference:

        TouchID.authenticate({
            reason: 'Verify to modify personal settings',
            callback: function(e) {
                Ti.API.info(e);
            }
        });
        
    ### Lifetime Notes (iOS-only)
    
    The current context will, once evaluated, be used until it's instance gets released or invalidated.
    You can you use the <Modules.TouchId.invalidate> method to force the user to be prompted every time a
    new authentication is triggered. On iOS 9 and later, this can also be called to cancel a current
    evaluation of an auth-context, e.g. to hide the auth-dialoag.
        
    ### Native Keychain Integration (iOS-only)
    
    For more infos regarding the keychain integration, check the <Modules.TiTouchId.KeychainItem>
    documentation.

    ### Sample Application

    The module contains a sample application in the
    `<TITANIUM_SDK_HOME>/modules/iphone/ti.touchid/<VERSION>/example/` folder.

methods:
  - name: authenticate
    summary: Initiates the Touch ID authentication process.
    description: |
      A special note for Android:

      When you call this method in Android, if you provide an incorrect fingerprint and receive an error
      message "Unable to recognize fingerprint", do not call authenticate. Instead, get the user to try
      again. If you call authenticate, it will end up in a bad state. This flow will be improved in the
      next update for Android.
    parameters:
      - name: params
        summary: Dictionary of arguments passed to the method, e.g. the reason to autheicate and the callback.
        type: TouchIdAuthenticationType

  - name: invalidate
    summary: Invalidates the current Touch ID dialog.
    description: |
        The context is invalidated automatically when it is (auto)released.

        This method allows invalidating it manually while it is still in scope.
        Invalidation terminates any existing policy evaluation and the respective call will
        fail with <Modules.TouchId.ERROR_APP_CANCELLED>. After the context has been invalidated, it can not be
        used for policy evaluation and an attempt to do so will fail with <Modules.TouchId.ERROR_INVALID_CONTEXT>.

        See the "Lifetime Notes (iOS-only)" paragraph in the module paragraph for more infos.

    platforms: [iphone, ipad, android]
    since: "6.1.0"

  - name: deviceCanAuthenticate
    summary: Checks to see if device is configured for Touch ID authentication.
    description: |
        On Android this takes into account the `authenticationPolicy`.

        Example:
            var TiTouchId = require("ti.touchid");
            var result = TiTouchId.deviceCanAuthenticate();
            if (!result.canAuthenticate) {
                alert('Message: ' + result.error + '\nCode: ' + result.code);
            } else {
                alert('Device can authenticate');
            }
    returns:
        type: DeviceCanAuthenticateResult

  - name: isSupported
    summary: Determines if the current device supports Touch ID.
    returns:
        type: Boolean

properties:
  - name: authenticationPolicy
    summary: Sets the global authentication policy used in this Touch ID context.
    description: |
        You should set this property before checking the availability or 
        starting the authentication. By default, `AUTHENTICATION_POLICY_BIOMETRICS`
        will be used to authenticate using the Touch ID sensor only. Using the
        `AUTHENTICATION_POLICY_PASSCODE` constant will still try to authenticate
        with Touch ID first and use the passcode as the fallback.
    platforms: [iphone, ipad, android]
    since: "6.1.0"
    type: Number
    constants: [Modules.TouchId.AUTHENTICATION_POLICY_*]
    default: Modules.TouchId.AUTHENTICATION_POLICY_BIOMETRICS

  - name: AUTHENTICATION_POLICY_PASSCODE
    summary: Device owner was authenticated by Touch ID or device passcode.
    description: |
        Touch ID or passcode authentication is required. If Touch ID is available,
        enrolled and not locked out, user is asked for it first, otherwise they are
        asked to enter device passcode. If passcode is not enabled, policy evaluation
        will fail.

        Touch ID authentication dialog behaves similarly as the one used by
        `AUTHENTICATION_POLICY_BIOMETRICS`. However, instead of "Enter Password"
        button there is "Enter Passcode" button which, when tapped, switches the
        authentication method and allows users to enter device passcode.

        Passcode authentication will get locked after 6 unsuccessful attempts with
        progressively increased backoff delay.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    since: "6.1.0"
    
  - name: AUTHENTICATION_POLICY_BIOMETRICS
    summary: Device owner was authenticated using a biometric method (Touch ID).
    description: |
        Touch ID authentication is required. If Touch ID is not available or not
        enrolled, policy evaluation will fail. If Touch ID is locked out, passcode
        is required as the first step to unlock the Touch ID.

        Touch ID authentication dialog contains a cancel button with default title
        "Cancel" which can be customized using `cancelTitle` property and a fallback
        button with default title "Enter Password" which can be customized using
        `fallbackTitle` property. Fallback button is initially hidden and shows up
        after first unsuccessful Touch ID attempt. Tapping cancel button or fallback
        button causes evaluatePolicy call to fail, returning a distinct error code.

        Biometric authentication will get locked after 5 unsuccessful attempts.
        After that, users have to unlock it by entering passcode.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    since: "6.1.0"

  - name: ERROR_AUTHENTICATION_FAILED
    summary: Constant indicating that the authentication was not successful.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]

  - name: ERROR_PASSCODE_NOT_SET
    summary: Constant indicating that the passcode is not set for the device.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    
  - name: ERROR_TOUCH_ID_NOT_AVAILABLE
    summary: Constant indicating that Touch ID is not available on the device.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]

  - name: ERROR_TOUCH_ID_NOT_ENROLLED
    summary: Constant indicating that Touch ID does not have any enrolled fingerprints.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]

  - name: ERROR_SYSTEM_CANCEL
    summary: |
        Constant indicating that iOS cancelled authentication, for example, if another
        application enters the foreground.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]

  - name: ERROR_USER_CANCEL
    summary: Constant indicating that the user canceled authentication.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]

  - name: ERROR_USER_FALLBACK
    summary: Constant indicating that the user tapped the fallback button to enter their passcode.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]

  - name: ERROR_APP_CANCELLED
    summary: Constant indicating that the app cancelled authentication.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]

  - name: ERROR_INVALID_CONTEXT
    summary: Constant indicating that there is an invalid context.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]

  - name: ERROR_TOUCH_ID_LOCKOUT
    summary: Constant indicating that Touch ID has locked out.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]

  - name: ERROR_KEY_PERMANENTLY_INVALIDATED
    summary: Constant indicating that the key has been permanentely invalidated.
    type: Number
    permission: read-only
    platforms: [android]

  - name: ACCESSIBLE_WHEN_UNLOCKED
    summary: |
        Item data can only be accessed while the device is unlocked. This is
        recommended for items that only need be accesible while the application
        is in the foreground. Items with this attribute will migrate to a new
        device when using encrypted backups.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]
    since: "6.1.0"

  - name: ACCESSIBLE_AFTER_FIRST_UNLOCK
    summary: |
        Item data can only be accessed once the device has been unlocked after
        a restart. This is recommended for items that need to be accesible by
        background applications. Items with this attribute will migrate to a new 
        device when using encrypted backups.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]
    since: "6.1.0"

  - name: ACCESSIBLE_ALWAYS
    summary: |
        Item data can always be accessed regardless of the lock state of the device.  
        This is not recommended for anything except system use. Items with this 
        attribute will migrate to a new device when using encrypted backups.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    since: "6.1.0"

  - name: ACCESSIBLE_WHEN_PASSCODE_SET_THIS_DEVICE_ONLY
    summary: |
         Item data can only be accessed while the device is unlocked. This class
         is only available if a passcode is set on the device. This is recommended
         for items that only need to be accessible while the application is in the
         foreground. Items with this attribute will never migrate to a new
         device, so after a backup is restored to a new device, these items
         will be missing. No items can be stored in this class on devices
         without a passcode. Disabling the device passcode will cause all
         items in this class to be deleted.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    since: "6.1.0"

  - name: ACCESSIBLE_WHEN_UNLOCKED_THIS_DEVICE_ONLY
    summary: |
        Item data can only be accessed while the device is unlocked. This is
        recommended for items that only need be accesible while the application
        is in the foreground. Items with this attribute will never migrate to a
        new device, so after a backup is restored to a new device, these items
        will be missing.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]
    since: "6.1.0"

  - name: ACCESSIBLE_AFTER_FIRST_UNLOCK_THIS_DEVICE_ONLY
    summary: |
        Item data can only be accessed once the device has been unlocked after a
        restart. This is recommended for items that need to be accessible by
        background applications. Items with this attribute will never migrate to
        a new device, so after a backup is restored to a new device these items
        will be missing.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]
    since: "6.1.0"

  - name: ACCESSIBLE_ALWAYS_THIS_DEVICE_ONLY
    summary: |
        Item data can always be accessed regardless of the lock state of the device.
        This option is not recommended for anything except system use. Items with
        this attribute will never migrate to a new device, so after a backup is
        restored to a new device, these items will be missing.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    since: "6.1.0"

  - name: ACCESS_CONTROL_USER_PRESENCE
    summary: |
        User presence policy using Touch ID or Passcode. Touch ID does not have
        to be available or enrolled. Item is still accessible by Touch ID even
        if fingers are added or removed.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    since: "6.1.0"

  - name: ACCESS_CONTROL_TOUCH_ID_ANY
    summary: |
        Constraint - Touch ID (any finger). Touch ID must be available and at least
        one finger must be enrolled. Item is still accessible by Touch ID even if
        fingers are added or removed.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    since: "6.1.0"

  - name: ACCESS_CONTROL_TOUCH_ID_CURRENT_SET
    summary: |
        Constraint - Touch ID from the set of currently enrolled fingers. Touch ID
        must be available and at least one finger must be enrolled. When fingers
        are added or removed, the item is invalidated.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    since: "6.1.0"

  - name: ACCESS_CONTROL_DEVICE_PASSCODE
    summary: Constraint - Device passcode.
    type: Number
    permission: read-only
    platforms: [iphone, ipad, android]
    since: "6.1.0"

  - name: ACCESS_CONTROL_OR
    summary: |
        Constraint logic operation - When using more than one constraint, at least
        one of them must be satisfied.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]
    since: "6.1.0"

  - name: ACCESS_CONTROL_AND
    summary: |
        Constraint logic operation - When using more than one constraint, all must
        be satisfied.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]
    since: "6.1.0"

  - name: ACCESS_CONTROL_PRIVATE_KEY_USAGE
    summary: Create access control for private key operations (i.e. sign operation).
    type: Number
    permission: read-only
    platforms: [iphone, ipad]
    since: "6.1.0"

  - name: ACCESS_CONTROL_APPLICATION_PASSWORD
    summary: |
        Security: Application provided password for data encryption key generation.
        This is not a constraint but additional item encryption mechanism.
    type: Number
    permission: read-only
    platforms: [iphone, ipad]
    since: "6.1.0"

  - name: FINGERPRINT_ACQUIRED_PARTIAL
    summary: Only a partial fingerprint image was detected.
    type: Number
    permission: read-only
    platforms: [android]
    since: "6.2.0"

  - name: FINGERPRINT_ACQUIRED_INSUFFICIENT
    summary: The fingerprint image was too noisy to process due to a detected condition (i.e. dry skin) or a possibly dirty sensor.
    type: Number
    permission: read-only
    platforms: [android]
    since: "6.2.0"

  - name: FINGERPRINT_ACQUIRED_IMAGER_DIRTY
    summary: The fingerprint image was too noisy due to suspected or detected dirt on the sensor.
    type: Number
    permission: read-only
    platforms: [android]
    since: "6.2.0"

  - name: FINGERPRINT_ACQUIRED_TOO_SLOW
    summary: The fingerprint image was unreadable due to lack of motion.
    type: Number
    permission: read-only
    platforms: [android]
    since: "6.2.0"

  - name: FINGERPRINT_ACQUIRED_TOO_FAST
    summary: The fingerprint image was incomplete due to quick motion.
    type: Number
    permission: read-only
    platforms: [android]
    since: "6.2.0"

---
name: TouchIdAuthenticationType
platforms: [android, iphone, ipad]
summary: Dictionary passed to <Modules.TouchId.authenticate>.
properties:
  - name: reason
    optional: false
    summary: |
        Note: This property is iOS only!

        Message displayed in the authentication dialog describing why the
        application is requesting authentication.
    type: String
    platforms: [iphone, ipad]

  - name: allowableReuseDuration
    summary: |
        Note: This property is iOS only!
        
        The time interval (in seconds) for accepting a successful Touch ID device
        unlock (on the lock screen) from the past. If the device was successfully
        unlocked by Touch ID within this time interval, then Touch ID authentication
        on this context will succeed automatically and the reply block will be
        called without prompting user for Touch ID.

        The default value is 0, meaning that no previous TouchID unlock can be reused.

        This property is meant only for reusing Touch ID matches from the device
        lock screen. It does not allow reusing previous Touch ID matches in
        application or between applications.

        The maximum supported interval is 5 minutes and setting the value beyond
        5 minutes does not increase the accepted interval.
    type: Number
    since: "6.1.0"
    platforms: [iphone, ipad]
    osver: {ios: {min: "9.0"}}

  - name: fallbackTitle
    summary: |
        Note: This property is iOS only!

        Allows fallback button title customization. A default localized title
        "Enter Password" is used when this property is left nil. If set to empty
        string, the button will be hidden.
    type: String
    since: "6.1.0"
    osver: {ios: {min: "10.0"}}
    platforms: [iphone, ipad]

  - name: cancelTitle
    summary: |
         Note: This property is iOS only!

         Allows cancel button title customization. A default localized title "Cancel"
         is used when this property is not defined or is set to empty string.
    type: String
    since: "6.1.0"
    osver: {ios: {min: "10.0"}}
    platforms: [iphone, ipad]

  - name: keepAlive
    summary: |
        Note: This property is iOS only!

        Determines whether the auth-context should be kept alive after authorizing
        with the TouchID-API and can be used to automatically terminate an auth-context
        after authorizing.

        Please note that calling `invalidate` will not be possible unless you
        have a valid auth-context, so you would decide whether to use `invalidate`
        to invalidate the context and release the auth-instance or use the `keepAlive`
        property inside `authenticate` to only terminate the context.
        
        Terminated contexts cannot be recovered and will be recreated with a new auth-context
        once `authenticate` is called again.
    type: Boolean
    since: "7.0.0"
    platforms: [iphone, ipad]

  - name: callback
    optional: false
    summary: |
        Callback function executed after the authentication completes.
        The callback function is passed a dictionary with three properties:

          * `success` (Boolean): Set to true if authentication succeeded.
          * `error` (String): System error message.
          * `code` (Number): Module `ERROR_*` constant indicating the reason for the failure.
    type: Callback

---
name: DeviceCanAuthenticateResult
platforms: [android, iphone, ipad]
summary: Dictionary containing results for <Modules.TouchId.deviceCanAuthenticate>.
since: {iphone: "3.4.0", ipad: "3.4.0", android: "5.4.0"}
properties:
  - name: canAuthenticate 
    summary: Set to true if device is configured for touch ID authentication.
    type: Boolean

  - name: error
    summary: System error message if any.
    type: String

  - name: code
    summary: iOS only, Module `ERROR_*` constant indicating the reason for the failure if any.
    type: Number
    platforms: [iphone, ipad]
